C51 COMPILER V9.57.0.0   ESP                                                               05/04/2023 16:48:24 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE ESP
OBJECT MODULE PLACED IN .\Objects\esp.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE include\esp.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\include) DEBUG OBJ
                    -ECTEXTEND PRINT(.\Listings\esp.lst) TABS(2) OBJECT(.\Objects\esp.obj)

line level    source

   1          #include "esp.h"
   2          
   3          /*----------uart4 ÈÉ®ÂàÜ----------*/
   4          #define BAUD 115200UL             //‰∏≤Âè£Ê≥¢ÁâπÁéá
   5          #define S4_S0 0x04              //P_SW2.2
   6          #define S4RI  0x01              //S4CON.0
   7          #define S4TI  0x02              //S4CON.1
   8          #define S4RB8 0x04              //S4CON.2
   9          #define S4TB8 0x08              //S4CON.3
  10          
  11          bit uart4_busy;
  12          unsigned char esp_race_buf[100] = {0};
  13          unsigned int esp_race_count = 0;
  14          char MQTTConnectData[] = {0x10 ,0xBC ,0x01 ,0x00 ,0x04 ,0x4D ,0x51 ,0x54 ,0x54 ,0x04 ,0xC2 ,0x01 ,0x2C ,0x
             -00 ,0x54 ,0x61 ,0x36 ,0x32 ,0x78 ,0x70 ,0x64 ,0x69 ,0x50 ,0x6D ,0x57 ,0x64 ,0x2E ,0x35 ,0x31 ,0x53 ,0x65 ,0x63 ,0x6F ,0x
             -6E ,0x64 ,0x54 ,0x65 ,0x73 ,0x74 ,0x7C ,0x73 ,0x65 ,0x63 ,0x75 ,0x72 ,0x65 ,0x6D ,0x6F ,0x64 ,0x65 ,0x3D ,0x32 ,0x2C ,0x
             -73 ,0x69 ,0x67 ,0x6E ,0x6D ,0x65 ,0x74 ,0x68 ,0x6F ,0x64 ,0x3D ,0x68 ,0x6D ,0x61 ,0x63 ,0x73 ,0x68 ,0x61 ,0x32 ,0x35 ,0x
             -36 ,0x2C ,0x74 ,0x69 ,0x6D ,0x65 ,0x73 ,0x74 ,0x61 ,0x6D ,0x70 ,0x3D ,0x31 ,0x36 ,0x37 ,0x34 ,0x36 ,0x30 ,0x38 ,0x34 ,0x
             -30 ,0x35 ,0x30 ,0x32 ,0x37 ,0x7C ,0x00 ,0x18 ,0x35 ,0x31 ,0x53 ,0x65 ,0x63 ,0x6F ,0x6E ,0x64 ,0x54 ,0x65 ,0x73 ,0x74 ,0x
             -26 ,0x61 ,0x36 ,0x32 ,0x78 ,0x70 ,0x64 ,0x69 ,0x50 ,0x6D ,0x57 ,0x64 ,0x00 ,0x40 ,0x61 ,0x37 ,0x64 ,0x32 ,0x35 ,0x61 ,0x
             -30 ,0x61 ,0x31 ,0x63 ,0x36 ,0x66 ,0x30 ,0x65 ,0x33 ,0x39 ,0x61 ,0x39 ,0x35 ,0x32 ,0x66 ,0x35 ,0x36 ,0x64 ,0x32 ,0x35 ,0x
             -34 ,0x38 ,0x61 ,0x63 ,0x36 ,0x31 ,0x39 ,0x31 ,0x66 ,0x62 ,0x39 ,0x62 ,0x38 ,0x30 ,0x36 ,0x34 ,0x35 ,0x30 ,0x39 ,0x37 ,0x
             -35 ,0x64 ,0x37 ,0x63 ,0x31 ,0x35 ,0x31 ,0x37 ,0x33 ,0x38 ,0x36 ,0x63 ,0x35 ,0x64 ,0x36 ,0x64 ,0x39 ,0x36};
  15          char MQTTPublishData[] = {0x30 ,0x2E ,0x00 ,0x25 ,0x2F ,0x61 ,0x36 ,0x32 ,0x78 ,0x70 ,0x64 ,0x69 ,0x50 ,0x
             -6D ,0x57 ,0x64 ,0x2F ,0x35 ,0x31 ,0x53 ,0x65 ,0x63 ,0x6F ,0x6E ,0x64 ,0x54 ,0x65 ,0x73 ,0x74 ,0x2F ,0x75 ,0x73 ,0x65 ,0x
             -72 ,0x2F ,0x75 ,0x70 ,0x64 ,0x61 ,0x74 ,0x65 ,0x23 ,0x23 ,0x23 ,0x23 ,0x23 ,0x23 ,0x23};
  16          char MQTTPingData[] = {0xC0 ,0x00};
  17          char MQTTDisconnectData[] = {0xE0 ,0x00};
  18          
  19          void Uart4Init(void)
  20          {
  21   1          P_SW2 |= S4_S0;             //S4_S0=1 (P5.2/RxD4_2, P5.3/TxD4_2)
  22   1          S4CON = 0x50;               //8‰ΩçÂèØÂèòÊ≥¢ÁâπÁéá
  23   1      
  24   1          T4L = (65536 - (MAIN_Fosc/4/BAUD));   //ËÆæÁΩÆÊ≥¢ÁâπÁéáÈáçË£ÖÂÄº
  25   1          T4H = (65536 - (MAIN_Fosc/4/BAUD))>>8;
  26   1          T4T3M |= 0x20;              //ÂÆöÊó∂Âô®4‰∏∫1TÊ®°Âºè
  27   1          T4T3M |= 0x80;              //ÂÆöÊó∂Âô®4ÂºÄÂßãËÆ°Êó∂
  28   1      
  29   1          IE2 = 0x10;                 //‰ΩøËÉΩ‰∏≤Âè£4‰∏≠Êñ≠
  30   1          EA = 1;
  31   1      }
  32          
  33          
  34          
  35          void Uart4() interrupt 18
  36          {
  37   1        if (S4CON & S4RI)
  38   1        {
  39   2          S4CON &= ~S4RI;         //Ê∏ÖÈô§S4RI‰Ωç
  40   2            
  41   2          esp_race_buf[esp_race_count] = S4BUF; 
  42   2          esp_race_count++;
  43   2          if(esp_race_count>=100)
C51 COMPILER V9.57.0.0   ESP                                                               05/04/2023 16:48:24 PAGE 2   

  44   2          {
  45   3            esp_race_count = 0;
  46   3          }
  47   2        }
  48   1        if (S4CON & S4TI)
  49   1        {
  50   2          S4CON &= ~S4TI;         //Ê∏ÖÈô§S4TI‰Ωç
  51   2          uart4_busy = 0;               //Ê∏ÖÂøôÊ†áÂøó
  52   2        }
  53   1      }
  54          
  55          
  56          void Uart4SendData(unsigned char dat)
  57          {
  58   1          
  59   1        S4CON &= ~S4TB8;        //ËÆæÁΩÆÊ†°È™å‰Ωç‰∏∫0
  60   1        uart4_busy = 1;
  61   1        S4BUF = dat;
  62   1        while (uart4_busy);
  63   1      }
  64          
  65          /*----------------------------
  66          ÂèëÈÄÅÂ≠óÁ¨¶‰∏≤
  67          ----------------------------*/
  68          void Uart4SendString(char *s)
  69          {
  70   1          while (*s)                  //Ê£ÄÊµãÂ≠óÁ¨¶‰∏≤ÁªìÊùüÊ†áÂøó
  71   1          {
  72   2              Uart4SendData(*s++);         //ÂèëÈÄÅÂΩìÂâçÂ≠óÁ¨¶
  73   2          }
  74   1      }
  75          
  76          /*----------esp ÈÉ®ÂàÜ----------*/
  77          
  78          /* ÂàùÂßãÂåñ esp8266 */
  79          void espInit(char *SSID, char *passwd, char *SIP, char *SPORT)
  80          {
  81   1          Uart4Init();
  82   1        uart1SendString("u4 init end\r\n");
  83   1      
  84   1      /*----------*/
  85   1        Uart4SendString("AT+CWJAP=\"");
  86   1          Uart4SendString(SSID);
  87   1          Uart4SendString("\",\"");
  88   1          Uart4SendString(passwd);
  89   1          Uart4SendString("\"\r\n");
  90   1      
  91   1        uart1SendString("AT+CWJAP=\"");
  92   1          uart1SendString(SSID);
  93   1          uart1SendString("\",\"");
  94   1          uart1SendString(passwd);
  95   1          uart1SendString("\"\r\n");
  96   1        delay_10s();
  97   1        uart1SendString("race:\r\n");//‰∏≤Âè£1ÂèëÈÄÅ‰ø°ÊÅØ
  98   1        esp_race_buf[esp_race_count] = '\0';
  99   1        uart1SendString(esp_race_buf);
 100   1        delay_ms(1000);//Âª∂Êó∂1Áßí
 101   1      
 102   1        WDT_CONTR = 0x17;
 103   1        
 104   1      /*----------*/
 105   1        esp_race_count = 0;//‰∏≤Âè£4Êé•Êî∂ËÆ°Êï∞Ê∏ÖÈõ∂
C51 COMPILER V9.57.0.0   ESP                                                               05/04/2023 16:48:24 PAGE 3   

 106   1        Uart4SendString("AT+CWMODE=1\r\n");
 107   1        uart1SendString("AT+CWMODE=1\r\n");
 108   1        delay_10s();
 109   1        uart1SendString("race:\r\n");//‰∏≤Âè£1ÂèëÈÄÅ‰ø°ÊÅØ
 110   1        esp_race_buf[esp_race_count] = '\0';
 111   1        uart1SendString(esp_race_buf);//Â∞Ü‰∏≤Âè£4Êî∂Âà∞ÁöÑÊï∞ÊçÆÈÄöËøá‰∏≤Âè£1ÂèëÈÄÅÁªôÁîµËÑë
 112   1        delay_ms(2000);
 113   1      
 114   1        WDT_CONTR = 0x17;
 115   1        
 116   1      /*----------*/
 117   1        esp_race_count = 0;//‰∏≤Âè£4Êé•Êî∂ËÆ°Êï∞Ê∏ÖÈõ∂
 118   1        Uart4SendString("AT+CIPMUX=0\r\n");//‰∏≤Âè£4ÂèëÈÄÅATÂëΩ‰ª§ÁªôWIFIÊ®°Âùó
 119   1        uart1SendString("AT+CIPMUX=0\r\n");
 120   1        delay_10s();//
 121   1        uart1SendString("race:\r\n");//‰∏≤Âè£1ÂèëÈÄÅ‰ø°ÊÅØ
 122   1        esp_race_buf[esp_race_count] = '\0';
 123   1        uart1SendString(esp_race_buf);//Â∞Ü‰∏≤Âè£4Êî∂Âà∞ÁöÑÊï∞ÊçÆÈÄöËøá‰∏≤Âè£1ÂèëÈÄÅÁªôÁîµËÑë
 124   1        delay_ms(2000);
 125   1      
 126   1        WDT_CONTR = 0x17;
 127   1        
 128   1      /*----------*/
 129   1        esp_race_count = 0;//‰∏≤Âè£4Êé•Êî∂ËÆ°Êï∞Ê∏ÖÈõ∂
 130   1      
 131   1        Uart4SendString("AT+CIPSTART=\"TCP\",\"");
 132   1          Uart4SendString(SIP);
 133   1          Uart4SendString("\",");
 134   1          Uart4SendString(SPORT);
 135   1          Uart4SendString("\r\n");
 136   1      
 137   1        uart1SendString("send:\r\nAT+CIPSTART=\"TCP\",\"");
 138   1          uart1SendString(SIP);
 139   1          uart1SendString("\",");
 140   1          uart1SendString(SPORT);
 141   1          uart1SendString("\r\n");
 142   1        delay_10s();//
 143   1        uart1SendString("race:\r\n");//‰∏≤Âè£1ÂèëÈÄÅ‰ø°ÊÅØ
 144   1        esp_race_buf[esp_race_count] = '\0';
 145   1        uart1SendString(esp_race_buf);//Â∞Ü‰∏≤Âè£4Êî∂Âà∞ÁöÑÊï∞ÊçÆÈÄöËøá‰∏≤Âè£1ÂèëÈÄÅÁªôÁîµËÑë
 146   1      
 147   1        WDT_CONTR = 0x17;
 148   1      
 149   1        delay_ms(2000);//
 150   1      
 151   1          uart1SendString("esp init end \r\n");
 152   1      }
 153          
 154          // void espSend(unsigned int length, char *wifi_send_buff)
 155          // {
 156          //     char templength = length;
 157          
 158          //     char buf[16];
 159          //     int i = 0;
 160          
 161          //     //uart1SendString("\r\nuse espSend\r\nlength is %d \r\n",length);
 162          
 163          //     esp_race_count = 0;//‰∏≤Âè£4Êé•Êî∂ËÆ°Êï∞Ê∏ÖÈõ∂
 164          
 165          //  Uart4SendString("send:\r\nAT+CIPSEND=");
 166          
 167          //     while (length > 0) {
C51 COMPILER V9.57.0.0   ESP                                                               05/04/2023 16:48:24 PAGE 4   

 168          //         buf[i++] = length % 10 + '0';  // Â∞ÜÊØè‰∏Ä‰ΩçÊï∞Â≠óËΩ¨Êç¢‰∏∫Â≠óÁ¨¶
 169          //         length /= 10;
 170          //     }
 171          
 172          //     while (i-- > 0) {
 173          //         Uart4SendData(buf[i]);  // ÈÄÜÂ∫èËæìÂá∫ÊØè‰∏Ä‰ΩçÊï∞Â≠óÂ≠óÁ¨¶
 174          //         uart1SendChar(buf[i]);
 175          //    uart1SendString("\r\n");
 176          //     }
 177          
 178          //     Uart4SendString("\r\n");
 179          
 180          //  while(1){
 181          //    if(esp_race_count - 2 >= 0 && esp_race_buf[esp_race_count - 2] == '>')
 182          //      break;
 183          //  }
 184          
 185          //     uart1SendString("\r\nrace:\r\n");//
 186          //     esp_race_buf[esp_race_count] = '\0';
 187          //  uart1SendString(esp_race_buf);
 188          
 189          //     esp_race_count = 0;//‰∏≤Âè£4Êé•Êî∂ËÆ°Êï∞Ê∏ÖÈõ∂
 190          //     i = 0;
 191          //     uart1SendString("\r\nwifi_send_buff\r\n");
 192          //     while(i < templength)
 193          //     {
 194          //         Uart4SendData(wifi_send_buff[i]);
 195          //         //uart1SendString("%c",wifi_send_buff[i]);
 196          //         i++;
 197          //     }
 198          
 199          //  Uart4SendString(wifi_send_buff);//‰∏≤Âè£4ÂèëÈÄÅÈúÄË¶ÅÂèëÈÄÅÁöÑÊï∞ÊçÆ   Êï∞ÊçÆÂú®wifi_send_buf Êï∞ÁªÑ‰∏
             -≠   Êï∞ÁªÑÁöÑÂÆö‰πâÂú®ÊúÄ‰∏äÈù¢
 200          //  delay_ms(1000);//
 201          
 202          //     Uart4SendString("+++");
 203          //  delay_ms(2000);
 204          // }
 205          
 206          unsigned char MQTTConnect()
 207          {
 208   1      
 209   1        unsigned int num = 0;
 210   1        esp_race_count = 0;
 211   1        delay_ms(100);
 212   1      
 213   1        Uart4SendString("AT+CIPSEND=191\r\n");
 214   1      
 215   1        while(1){
 216   2          if(esp_race_count - 2 >= 0 && esp_race_buf[esp_race_count - 2] == '>')
 217   2            break;
 218   2        }
 219   1        delay_ms(1000);
 220   1        esp_race_count = 0;
 221   1      
 222   1        Uart4SendData(0x10);
 223   1      
 224   1        for(num = 1;num < 191;num++)
 225   1        {
 226   2          Uart4SendData(MQTTConnectData[num]);
 227   2        }
 228   1        delay_ms(1000);
C51 COMPILER V9.57.0.0   ESP                                                               05/04/2023 16:48:24 PAGE 5   

 229   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 230   1        
 231   1        uart1SendChar('0'+esp_race_count);
 232   1        Uart1SendData(esp_race_buf,esp_race_count);
 233   1        //Uart4SendString("+++");
 234   1        
 235   1        delay_ms(2000);
 236   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 237   1        delay_ms(2000);
 238   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 239   1        delay_ms(2000);
 240   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 241   1        delay_ms(2000);
 242   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 243   1        delay_ms(2000);
 244   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 245   1        return 1;
 246   1      }
 247          
 248          unsigned char MQTTPublish(char *mqttdata)
 249          {
 250   1        unsigned int num = 0;
 251   1        esp_race_count = 0;
 252   1      
 253   1        MQTTPublishData[41] = mqttdata[0];
 254   1        MQTTPublishData[42] = mqttdata[1];
 255   1        MQTTPublishData[43] = mqttdata[2];
 256   1        MQTTPublishData[44] = mqttdata[3];
 257   1        MQTTPublishData[45] = mqttdata[4];
 258   1        MQTTPublishData[46] = mqttdata[5];
 259   1        MQTTPublishData[47] = mqttdata[6];
 260   1      
 261   1        Uart4SendString("AT+CIPSEND=48\r\n");
 262   1        
 263   1        while(1){
 264   2          if((esp_race_count - 2 >= 0 && esp_race_buf[esp_race_count - 2] == '>')||(esp_race_count - 1 >= 0 && esp
             -_race_buf[esp_race_count - 1] == '>')||(esp_race_count >= 0 && esp_race_buf[esp_race_count] == '>'))
 265   2            break;
 266   2        }
 267   1        delay_ms(1000);
 268   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 269   1      
 270   1        for(num = 0;num < 48;num++)
 271   1        {
 272   2          Uart4SendData(MQTTPublishData[num]);
 273   2        }
 274   1        delay_ms(1000);
 275   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 276   1      
 277   1        Uart4SendString("+++");
 278   1        WDT_CONTR = 0X37; //ÂñÇÁãóÊìç‰Ωú 
 279   1        delay_ms(2000);
 280   1        return 1;
 281   1      }
 282          unsigned char MQTTPing()
 283          {
 284   1        unsigned int num = 0;
 285   1        esp_race_count = 0;
 286   1        Uart4SendString("AT+CIPSEND=2\r\n");
 287   1        while(1){
 288   2          if(esp_race_count - 2 >= 0 && esp_race_buf[esp_race_count - 2] == '>')
 289   2            break;
C51 COMPILER V9.57.0.0   ESP                                                               05/04/2023 16:48:24 PAGE 6   

 290   2        }
 291   1        delay_ms(1000);
 292   1      
 293   1        for(num = 0;num < 2;num++)
 294   1        {
 295   2          Uart4SendData(MQTTPingData[num]);
 296   2        }
 297   1        delay_ms(1000);
 298   1      
 299   1          Uart4SendString("+++");
 300   1        delay_ms(2000);
 301   1        return 1;
 302   1      }
 303          unsigned char MQTTDisconnect()
 304          {
 305   1        unsigned int num = 0;
 306   1        esp_race_count = 0;
 307   1        Uart4SendString("AT+CIPSEND=2\r\n");
 308   1        while(1){
 309   2          if(esp_race_count - 2 >= 0 && esp_race_buf[esp_race_count - 2] == '>')
 310   2            break;
 311   2        }
 312   1        delay_ms(1000);
 313   1      
 314   1        for(num = 0;num < 2;num++)
 315   1        {
 316   2          Uart4SendData(MQTTDisconnectData[num]);
 317   2        }
 318   1        delay_ms(1000);
 319   1      
 320   1          Uart4SendString("+++");
 321   1        delay_ms(2000);
 322   1        return 1;
 323   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1304    ----
   CONSTANT SIZE    =    190    ----
   XDATA SIZE       =    345      17
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
